<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foto com Moldura</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#f5f5f5;
      padding:16px;
    }
    .card {
      background:#fff;
      padding:14px;
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    canvas {
      display:block;
      max-width:100%;
      background:#000;
      border-radius:12px;
      margin-top:12px;
      touch-action:none;
    }
    button {
      padding:10px 14px;
      margin-right:8px;
      margin-top:8px;
      cursor:pointer;
    }
    .hint {
      font-size:13px;
      color:#444;
      margin-top:8px;
    }
  </style>
</head>
<body>

<h2>Envie sua foto e ajuste</h2>

<div class="card">
  <input id="photo" type="file" accept="image/*" />
  <br>
  <button id="download" disabled>Baixar imagem</button>

  <div class="hint">
    • Arraste com 1 dedo<br>
    • Use <strong>pinça com dois dedos</strong> para dar zoom
  </div>

  <canvas id="c" width="1080" height="1920"></canvas>
</div>

<script>
const W = 1080, H = 1920;
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

const input = document.getElementById('photo');
const btnDownload = document.getElementById('download');

const frame = new Image();
frame.src = 'frame.png';

let img = null;

// transformação
let baseScale = 1;
let scale = 1;
let offsetX = 0;
let offsetY = 0;

// touch
let isDragging = false;
let lastTouchX = 0;
let lastTouchY = 0;
let pinchStartDist = 0;
let pinchStartScale = 1;

function distance(t1, t2) {
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.hypot(dx, dy);
}

function clamp() {
  if (!img) return;
  const dw = img.width * baseScale * scale;
  const dh = img.height * baseScale * scale;

  const minX = W - dw;
  const minY = H - dh;

  offsetX = Math.min(0, Math.max(minX, offsetX));
  offsetY = Math.min(0, Math.max(minY, offsetY));
}

function render() {
  ctx.clearRect(0, 0, W, H);

  if (img) {
    clamp();
    const dw = img.width * baseScale * scale;
    const dh = img.height * baseScale * scale;
    ctx.drawImage(img, offsetX, offsetY, dw, dh);
  }

  if (frame.complete) {
    ctx.drawImage(frame, 0, 0, W, H);
  }
}

function setupImage(image) {
  img = image;
  const sx = W / img.width;
  const sy = H / img.height;
  baseScale = Math.max(sx, sy);

  scale = 1;
  const dw = img.width * baseScale;
  const dh = img.height * baseScale;

  offsetX = (W - dw) / 2;
  offsetY = (H - dh) / 2;

  btnDownload.disabled = false;
  render();
}

input.addEventListener('change', () => {
  const file = input.files?.[0];
  if (!file) return;

  const image = new Image();
  image.onload = () => setupImage(image);
  image.src = URL.createObjectURL(file);
});

// TOUCH EVENTS (PINÇA)
canvas.addEventListener('touchstart', (e) => {
  if (!img) return;

  if (e.touches.length === 1) {
    isDragging = true;
    lastTouchX = e.touches[0].clientX;
    lastTouchY = e.touches[0].clientY;
  }

  if (e.touches.length === 2) {
    pinchStartDist = distance(e.touches[0], e.touches[1]);
    pinchStartScale = scale;
  }
}, { passive:false });

canvas.addEventListener('touchmove', (e) => {
  if (!img) return;
  e.preventDefault();

  if (e.touches.length === 1 && isDragging) {
    const dx = e.touches[0].clientX - lastTouchX;
    const dy = e.touches[0].clientY - lastTouchY;

    offsetX += dx * (W / canvas.getBoundingClientRect().width);
    offsetY += dy * (H / canvas.getBoundingClientRect().height);

    lastTouchX = e.touches[0].clientX;
    lastTouchY = e.touches[0].clientY;
    render();
  }

  if (e.touches.length === 2) {
    const dist = distance(e.touches[0], e.touches[1]);
    scale = pinchStartScale * (dist / pinchStartDist);
    scale = Math.max(1, Math.min(3, scale));
    render();
  }
}, { passive:false });

canvas.addEventListener('touchend', () => {
  isDragging = false;
});

// Download
btnDownload.addEventListener('click', () => {
  const a = document.createElement('a');
  a.download = 'foto-com-moldura-1080x1920.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
});

frame.onload = render;
render();
</script>

</body>
</html>
